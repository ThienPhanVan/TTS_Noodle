<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <th:block th:replace="/layout/script/head :: head"></th:block>
    <title>Profit</title>
</head>

<body>
<!-- loader Start -->
<div id="loading">
    <div id="loading-center">
    </div>
</div>
<!-- loader END -->
<!-- Wrapper Start -->
<div class="wrapper">
    <!-- Sidebar  -->

    <th:block th:replace="/layout/sidebar/left_side_bar.html"></th:block>
    <!-- TOP Nav Bar -->

    <div class="iq-top-navbar">
        <div style="margin-top: 13px;" class="iq-navbar-custom">
            <nav class="navbar navbar-expand-lg navbar-light p-0">

                <h4 class="text-primary">Báo Cáo Lợi Nhuận</h4>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav ml-auto navbar-list">

                    </ul>
                </div>
                <ul class="navbar-list">
                    <li class="line-height">
                        <div class="mr-5">
                            <label>
                                <select id="selectDay" class="selectProfit text-center">
                                    <option selected value="toDay">Hôm Nay</option>
                                    <option value="sevenDay">7 Ngày Gần Nhất</option>
                                    <option value="oneMonth">1 Tháng</option>
                                </select>
                            </label>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <!-- TOP Nav Bar END -->

    <!-- Page Content  -->
    <div id="content-page" class="content-page">
        <div class="container-fluid">
            <div class="row justify-content-between">
                <div class="col-sm-6 col-md-6 col-lg-3">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-body iq-box-relative">
                            <div class="iq-box-absolute icon iq-icon-box rounded-circle iq-bg-primary">
                                <i class="ri-focus-2-line"></i>
                            </div>
                            <p class="text-secondary">Doanh Số</p>
                            <div id="doanhso" class="d-flex align-items-center justify-content-between">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-sm-6 col-md-6 col-lg-3">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-body iq-box-relative">
                            <div class="iq-box-absolute icon iq-icon-box rounded-circle iq-bg-success">
                                <i class="ri-database-2-line"></i>
                            </div>
                            <p class="text-secondary">Chi Phí</p>
                            <div id="chiphi" class="d-flex align-items-center justify-content-between">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-md-6 col-lg-3">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-body iq-box-relative">
                            <div class="iq-box-absolute icon iq-icon-box rounded-circle iq-bg-warning">
                                <i class="ri-pie-chart-2-line"></i>
                            </div>
                            <p class="text-secondary">Lợi Nhuận</p>
                            <div id="loinhuan" class="d-flex align-items-center justify-content-between">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <div class="iq-card">
                        <div class="iq-card-body">
                            <div style="display: block" id="s1" class="table-responsive">
                                <table class="table table-striped table-bordered mt-4"
                                       role="grid"
                                       aria-describedby="user-list-page-info">

                                    <thead class="btn-primary">

                                    <tr class="text-center">
                                        <th>Mã SP</th>
                                        <th>Tên</th>
                                        <th>Ngày</th>
                                        <th>Doanh Số</th>
                                        <th>Chi Phí</th>
                                        <th>Lợi Nhuận</th>
                                    </tr>
                                    </thead>
                                    <tbody class="text-center">
                                    </tbody>
                                </table>
                            </div>
                            <div style="display: none" id="s2" class="table-responsive">
                                <table class="table table-striped table-bordered mt-4"
                                       role="grid"
                                       aria-describedby="user-list-page-info">

                                    <thead class="btn-primary">

                                    <tr class="text-center">
                                        <th>Mã SP</th>
                                        <th>Tên</th>
                                        <th>Ngày</th>
                                        <th>Doanh Số</th>
                                        <th>Chi Phí</th>
                                        <th>Lợi Nhuận</th>
                                    </tr>
                                    </thead>
                                    <tbody class="text-center">
                                    </tbody>
                                </table>
                            </div>

                            <div style="display: none" id="s3" class="table-responsive">
                                <table class="table table-striped table-bordered mt-4"
                                       role="grid"
                                       aria-describedby="user-list-page-info">

                                    <thead class="btn-primary">

                                    <tr class="text-center">
                                        <th>Mã SP</th>
                                        <th>Tên</th>
                                        <th>Ngày</th>
                                        <th>Doanh Số</th>
                                        <th>Chi Phí</th>
                                        <th>Lợi Nhuận</th>
                                    </tr>
                                    </thead>
                                    <tbody class="text-center">
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>


        </div>
    </div>
    <!-- Wrapper END -->
    <!-- Footer -->
    <th:block th:replace="/layout/footer/footer.html"></th:block>
    <!-- Footer END -->

</div>
<!--<script src="/static/assets/js/app.js"></script>-->
<th:block th:replace="/layout/script/footer :: footer"></th:block>

</body>

<script>
    let user = new User();
    let product = new Product();
    let value = 1;
    $("#addRow").on('click', function (){
        // value  = +$(".item .stt").text();
        value++;

        let str = `
        <tr id="${value}" >
            <td>${value}</td>
            <td>
                <label>
                    <select  class="selectProfit text-center">
                        <option selected value="toDay">Chọn</option>
                        <option value="sevenDay">Nước</option>
                        <option value="oneMonth">Điện</option>
                        <option value="oneMonth">Gạo</option>
                        <option value="oneMonth">Bột Lọc</option>
                        <option value="oneMonth">Bao Bì</option>
                        <option value="oneMonth">Nhân Viên</option>
                    </select>
                </label>
            </td>
            <td><label>
                <input type="number">
            </label>
            </td>
            <td><label>
                <input type="text">
            </label></td>
        </tr>
        `;
        $("#s3 tbody").append(str);
    })


    // function getProfit1Month(){
    //     $("#s3 tbody").empty();
    //     turnover.empty();
    //     costs.empty();
    //     profits.empty();
    //
    // }


    function getProduct() {
        return (
            $.ajax({
                headers: {
                    "Accept": 'application/json',
                    "Content-type": 'application'
                },
                async: false,
                type: "GET",
                url: "http://localhost:8080/api/products",
            }).done((data) => {
                user = data
             }).fail((jxHQR) => {
                console.log(jxHQR)
            })
        )
    }
    getProduct();

    $("#selectDay").on('change', () => {
        let getValue = $('#selectDay').val();
        let profitOD = $("#s1");
        let profitOW = $("#s2");
        let profitOM = $("#s3");
        switch (getValue) {
            case "toDay":
                profitOD.css('display', 'block');
                profitOW.css('display', 'none');
                profitOM.css('display', 'none');
                getProfit1Day();
                break;
            case "sevenDay" :
                profitOD.css('display', 'none');
                profitOM.css('display', 'none');
                profitOW.css('display', 'block');
                getProfit1Week();
                break;
            case "oneMonth" :
                profitOW.css('display', 'none');
                profitOD.css('display', 'none');
                profitOM.css('display', 'block');
                getProfit1Month();
                break;
            default :
                alert("hazz")
        }
    })
    let turnover = $("#doanhso");
    let costs = $("#chiphi");
    let profits = $("#loinhuan");

    function getProfit1Day() {
        $("#s1 tbody").empty();
        turnover.empty();
        costs.empty();
        profits.empty();
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "GET",
            async: false,
            url: "http://localhost:8080/api/order-items/getProfit1Day",
        }).done((data) => {
             let id;
            let nameProduct;
            let quantity = data[0].quantity;
            let totalOrder = 0;
            let quantityRice = Math.floor(quantity / 2.4);
            let cost = quantityRice * 10000;
            let profit = 0;

            let dateObj = new Date();
            let month = dateObj.getUTCMonth() + 1; //months from 1-12
            let day = dateObj.getUTCDate();
            let year = dateObj.getUTCFullYear();
            let dayNow = day + "/" + month + "/" + year;
            getProductById(data[0].productId).then((product) => {
                id = product.id;
                nameProduct = product.title;
                totalOrder = quantity * product.price;
                profit = totalOrder - cost;
                let str = `
            <tr id="tr_${id}">
                    <td>${id}</td>
                    <td>${nameProduct}</td>
                    <td>${dayNow}</td>
                    <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(totalOrder)}</td>
                    <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(cost)}</td>
                    <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(profit)}</td>
            </tr>
                   `;
                $("#s1 tbody").prepend(str);
            })

            let doanhso = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(totalOrder)}</b></h4> `;
            let chiphi = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(cost)}</b></h4> `;
            let loinhuan = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(profit)}</b></h4> `;
            turnover.prepend(doanhso);
            costs.prepend(chiphi);
            profits.prepend(loinhuan);
        }).fail((jqXHR) => {
            console.log(jqXHR)
        })
    }

    getProfit1Day();

    function getProfit1Week() {
        $("#s2 tbody").empty();
        turnover.empty();
        costs.empty();
        profits.empty();
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            async: false,
            type: "GET",
            url: "http://localhost:8080/api/order-items/getProfit1Week",
        }).done((data) => {
             let sumTotalOrder = 0;
            let sumCost = 0;
            let sumProfit = 0;
            $.each(data, (i, item) => {
                let id;
                let nameProduct;
                let quantity = item.quantity;
                let totalOrder = 0;
                let quantityRice = Math.floor(quantity / 2.4);
                let cost = quantityRice * 10000;
                let profit = 0;
                let days = item.createdAt;

                sumCost += cost;
                getProductById(item.productId).then((product) => {
                     id = product.id;
                    nameProduct = product.title;
                    totalOrder = quantity * product.price;
                    profit = totalOrder - cost;
                    sumTotalOrder += totalOrder;
                    sumProfit += profit;
                    let str = `
            <tr  id="tr_${id}">
                    <td>${id}</td>
                    <td>${nameProduct}</td>
                    <td>${moment(days).format("DD/MM/YYYY")}</td>
                    <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(totalOrder)}</td>
                    <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(cost)}</td>
                    <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(profit)}</td>
            </tr>
                   `;
                    $("#s2 tbody").append(str);
                })
            })
            let doanhso = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(sumTotalOrder)}</b></h4> `;
            let chiphi = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(sumCost)}</b></h4> `;
            let loinhuan = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(sumProfit)}</b></h4> `;
            turnover.prepend(doanhso);
            costs.prepend(chiphi);
            profits.prepend(loinhuan);
        }).fail((jqXHR) => {
            console.log(jqXHR)
        })
    }

    // getProfit1Week();

    function getProfit1Month() {
        $("#s3 tbody").empty();
        turnover.empty();
        costs.empty();
        profits.empty();
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            async: false,
            type: "GET",
            url: "http://localhost:8080/api/profits",
        }).done((data) => {
              let sumTotalOrder = 0;
            let sumCost = 0;
            let sumProfit = 0;
            let id;
            let nameProduct;
            $.each(user, (i,item)=>{
                if (item.id ===1){
                    return(
                    id = item.id ,
                    nameProduct = item.title)
                }

            })
            $.each(data, (i, item) => {

                let cost = item.bag + item.powder + item.staff + item.rice + item.water + item.electric;
                let turnover = item.turnover;
                let days = item.createdAt;
                let profit = turnover - cost;
                sumTotalOrder += turnover;
                sumCost += cost;
                sumProfit += profit;

                    let str = `
                                <tr  id="tr_${id}">
                                        <td>${id}</td>
                                        <td>${nameProduct}</td>
                                        <td>${moment(days).format("DD/MM/YYYY")}</td>
                                        <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(turnover)}</td>
                                        <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(cost)}</td>
                                        <td>${new Intl.NumberFormat("vi-VN", {style: 'currency', currency: 'VND'}).format(profit)}</td>
                                </tr>
                                `;
                    $("#s3 tbody").append(str);

            })
            let doanhso = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(sumTotalOrder)}</b></h4> `;
            let chiphi = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(sumCost)}</b></h4> `;
            let loinhuan = `<h4><b>${new Intl.NumberFormat("vi-VN", {
                style: 'currency',
                currency: 'VND'
            }).format(sumProfit)}</b></h4> `;
            turnover.prepend(doanhso);
            costs.prepend(chiphi);
            profits.prepend(loinhuan);
        }).fail((jqXHR) => {
            console.log(jqXHR)
        })
    }

    // getProfit1Month();

    function getProductById(productId) {
        return (
            $.ajax({
                headers: {
                    "Accept": 'application/json',
                    "Content-type": 'application'
                },
                async: false,
                type: "GET",
                url: "http://localhost:8080/api/products/" + productId,
            }).done((data) => {
                // console.log(data, "1")
            }).fail((jxHQR) => {
                console.log(jxHQR)
            })
        )
    }



</script>
</html>
<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <th:block th:replace="/layout/script/head :: head"/>
</head>

<body>
<!-- loader Start -->
<!--<div id="loading">-->
<!--    <div id="loading-center">-->
<!--    </div>-->
<!--</div>-->
<!-- loader END -->
<!-- Wrapper Start -->
<div class="wrapper">

    <th:block th:replace="/layout/sidebar/left_side_bar.html"/>
    <!-- TOP Nav Bar -->
    <th:block th:replace="/layout/topNav/topNav :: topNav"/>
    <!-- Sidebar  -->
    <!-- TOP Nav Bar -->
    <!-- TOP Nav Bar END -->

    <!-- Page Content  -->
    <div id="content-page" class="content-page">
        <div class="container-fluid">
            <div class="row">
                <a class="form-control-sm" href="/purchase">
                    <i class="fas fa-chevron-left"></i>
                    <span>Kho hàng</span>
                </a>
            </div>
            <div class="row">
                <h3>Phiếu nhập hàng</h3>
            </div>
            <div class="row" style="margin-top: 25px;">
                <div class="list-group col-md-8">
                    <div class="list-group">
                        <div class="supplier-info">
                            <h5>Thông tin sản phẩm</h5>
                            <div class="filter_product_box">
                                <nav class="navbar navbar-light bg-light">
                                    <div class="row">
<!--                                        <div class="search-box">-->
<!--                                            <form class="form-inline">-->
<!--                                                <input  class="form-control form-control-sm mr-sm-2" type="search" id="doSearch" placeholder="Tìm kiếm sản phẩm" aria-label="Search">-->
<!--                                                <button class="btn btn-outline-primary my-2 my-sm-1 btn-sm" type="submit">Tìm kiếm</button>-->
<!--                                            </form>-->
<!--                                        </div>-->
                                        <div class="list-group">
<!--                                            <div class="card-body">-->
<!--                                                <h5 class="card-title">Card title</h5>-->
<!--                                                <p class="card-text">With supporting text below as a natural lead-in to additional content.</p>-->
<!--                                            </div>-->
                                        </div>
                                        <div class="dropdown">
                                            <a class="btn dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                <input class="form-control search" type="search" placeholder="Tìm kiếm sản phẩm" aria-label="Search" />
                                            </a>
                                            <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                                                <a class="dropdown-item" >Không tìm thấy sản phẩm</a>
<!--                                                <a class="dropdown-item" href="#">Another action</a>-->
<!--                                                <a class="dropdown-item" href="#">Something else here</a>-->
                                            </div>
                                        </div>
                                    </div>
                                </nav>
                            </div>
                            <div class="list-product-purchase">
                                <table class="table" id="tbItemPurchase">
                                    <thead class="bg-primary">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">Tên sản phẩm</th>
                                        <th scope="col">Số lượng</th>
                                        <th scope="col">Giá nhập</th>
                                        <th scope="col">Thành tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody>
<!--                                    <tr>-->
<!--                                        <th scope="row">1</th>-->
<!--                                        <td>Mark</td>-->
<!--                                        <td>100</td>-->
<!--                                        <td>1000</td>-->
<!--                                        <td>100000</td>-->
<!--                                    </tr>-->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="list-group col-md-4">
                    <div class="purchase-info">
                        <h5>Thông tin phiếu nhập hàng</h5>
                        <div class="filter_product_box">
                            <nav class="navbar navbar-light bg-light">
                                <form class="form-inline">
                                    <input style="margin-left: -16px" class="form-control form-control-sm mr-sm-1" id="supplierOrder" type="search" placeholder="Nhập tên nhà cung cấp" aria-label="Search">
                                    <div class="btn btn-primary">
                                        <a class="text-white create" id="createSupplier">
                                            <i class="fa fa-plus"></i>
                                        </a>
                                    </div>
                                </form>
                            </nav>
                        </div>
                        <input class="form-control mt-2" id="dateID" type="date" min= name="dateTime" value="Ngày tạo"/>
                    </div>
                    <div class="bill_info" style="margin-top: 15px;">
                        <h5>Thông tin thanh toán</h5>
                        <span>Tổng cộng</span>
                        <span class="grandTotal"></span>
                    </div>
                    <button id="btnImportOrder" class="btn btn-primary">
                        Nhập hàng
                    </button>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- Wrapper END -->
<!-- Footer -->
<footer class="iq-footer">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-6">
                <ul class="list-inline mb-0">
                    <li class="list-inline-item"><a href="privacy-policy.html">Privacy Policy</a></li>
                    <li class="list-inline-item"><a href="terms-of-service.html">Terms of Use</a></li>
                </ul>
            </div>
            <div class="col-lg-6 text-right">
                Copyright 2020 <a href="#">FinDash</a> All Rights Reserved.
            </div>
        </div>
    </div>
</footer>

<th:block th:replace="/user/supplier/modalCreateSupplier :: createSupplier"/>

<script>
    var colors = ['#007bff', '#28a745', '#444444', '#c3e6cb', '#dc3545', '#6c757d'];

    var chBar = document.getElementById("chBar");
    var chartData = {
        labels: ["Monday", "Tusday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"],
        datasets: [

            {
                data: [489, 135, 483, 290, 189, 603, 600],
                backgroundColor: colors[0]
            },
            {
                data: [639, 465, 493, 478, 589, 632, 674],
                backgroundColor: colors[1]
            }]
    };

    if (chBar) {
        new Chart(chBar, {
            type: 'bar',
            data: chartData,
            options: {
                scales: {
                    xAxes: [{
                        barPercentage: 0.4,
                        categoryPercentage: 0.5
                    }],
                    yAxes: [{
                        ticks: {
                            beginAtZero: false
                        }
                    }]
                },
                legend: {
                    display: false
                }
            }
        });
    }

</script>
<!-- Footer END -->
<th:block th:replace="/layout/script/footer :: footer" />
<script>

    let order = new Order();

    let user = new User();

    let item = new Item();

    let product = new Product();



    $(
        function(){
            //Display Only Date till today //

            let dtToday = new Date();

            let month = dtToday.getMonth() + 1;
            let day = dtToday.getDate();
            let year = dtToday.getFullYear();
            if(month < 10)
                month = '0' + month.toString();
            if(day < 10)
                day = '0' + day.toString();

            let minDate= year + '-' + month + '-' + day;

            $('#dateID').attr('min', minDate);
        }
    )

    function renderProduct(obj){

        let str = `
                 <tr id = "tr_${obj.id}">
                    <th scope="row">${obj.id}</th>
                    <td>${obj.title}</td>
                    <td >
                        <input class="form-control form-control-sm quantityItemPurchase" type="number" value="1">
                    </td>
                    <td>
                        <input class="form-control form-control-sm priceItemPurchase" type="number" value="${obj.price}">
                        </td>
                    <td>
                        <input disabled class="form-control form-control-sm itemTotalAmount" type="number" value="0">
                    </td>
                </tr>
        `
        return str;
    }

    function renderProductBox(obj){

        // let str = `
        //             <div class="listProduct" id="tr_${obj.id}">
        //                  <a href="#" class="list-group-item list-group-item-action list-group-item-me-2 active">
        //                  Tên sản phẩm: ${obj.title}
        //                      <p class="card-text">Giá:
        //                          <b>${obj.price} đ</b>
        //                      </p>
        //                   </a>
        //             </div>
        //          `

        let str = `
                <a class="dropdown-item" id="tr_${obj.id} href="#">Tên sản phẩm: ${obj.title}
                        <p class="card-text">Giá:
                             <b>${obj.price} đ</b>
                          </p>
                </a>
                `
        return str;
    }

    // <div className="list-group-item w-65" id="tr_${obj.id}">
    //     <h5 className="card-title">Tên sản phẩm: ${obj.title}</h5>
    //     <p className="card-text">Giá:
    //         <b>${obj.price} đ</b>
    //     </p>
    // </div>


    function handleQuantityItemPurchase() {
        $(".quantityItemPurchase").on("input", function () {
            let quantity = +$(this).val();

            let rowId = $(this).parents().parents().attr("id");

            let price = $("#" + rowId + " .priceItemPurchase").val();

            let newAmount = quantity * price;

            $("#" + rowId + " .itemTotalAmount").val(newAmount)

            handleGrandTotal();
        })
    }

    function handlePriceItemPurchase() {
            $(".priceItemPurchase").on("input", function () {
            let price = +$(this).val();

            let rowId = $(this).parents().parents().attr("id");

            let quantity = $("#" + rowId + " .quantityItemPurchase").val();

            let newAmount = quantity * price;

            $("#" + rowId + " .itemTotalAmount").val(newAmount)

            handleGrandTotal();
        })
    }

    function handleGrandTotal(){
        let grandTotal = 0;
        console.log(grandTotal);


        $("#tbItemPurchase tbody tr").each(function (){

            let rowId = $(this).attr("id");

            let item = $("#" + rowId + " .itemTotalAmount");

            let subTotal = +$(item).val();

            grandTotal += subTotal;

        })

        console.log(grandTotal);

        $(".grandTotal").text(grandTotal);
    }

    $(".itemTotalAmount").on('input',handleGrandTotal);



    function getAllProduct(){
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "GET",
            url: "http://localhost:8080/api/products"
        })
        .done((data)=>{
            $.each(data, (i,item)=>{
                product = item;

                let str = renderProduct(item)

                $("#tbItemPurchase tbody").prepend(str);

                groupEvent();

            })

            handleImportOrder();

        })
        .fail((jqXHR)=>{
            console.log(jqXHR)
        })
    }

    function groupEvent(){

        handleQuantityItemPurchase();

        handlePriceItemPurchase();

    }

    function importPurchaseOrder(){
        $.ajax({
            headers: {
                "accept": "application/json",
                "content-type": "application/json"
            },
            type: "POST",
            url: "http://localhost:8080/api/orders/create/import"
        })
        .done(() => {

            iziToast.success({
                title: 'OK',
                position: 'bottomLeft',
                timeout: 1500,
                message: 'Nhập hàng thành công!!'
            });

        })
        .fail((jqXHR)=> {

            console.log(jqXHR);

            iziToast.error({
                title: 'ERROR',
                position: 'bottomLeft',
                timeout: 2000,
                message: 'Nhập hàng thất bại!'
            });

        })
    }

    function handleImportOrder(){
        $("btnImport").on("click", () => {
            importPurchaseOrder();
        })
    }

    function searchByName(keySearch){
        return $.ajax({
            "headers": {
                "accept": "application/json",
                "content-type": "application/json"
            },
            "type": "GET",
            "url": "http://localhost:8080/api/products/search/" + keySearch
        })
        .done((data)=> {
            $(".dropdown .dropdown-menu").html("");
            console.log(keySearch);
            $.each(data, (i,item)=>{
                product = item;
                product.price = App.formatNumberSpace(product.price);

                let str = renderProductBox(item);
                console.log(item)

                $(".dropdown .dropdown-menu").prepend(str);
            })
        })
    }

    function enableTooltip() {
        $('[data-toggle="tooltip"]').tooltip();
    }

    let btnCreate = $("#btnCreateSup");

    btnCreate.on("click", function () {
        let createUser = {
            "roleId": 0,
            "fullName": $('#nameSup').val(),
            "phone": $('#phoneSup').val(),
            "email": $('#emailSup').val(),
            "address": $('#addressSup').val(),
            "avatarUrl": "https://enshaafuture.com/public/img/default-avatar.jpg",
        }
        console.log(createUser)
        $.ajax({
            headers: {
                'Accept': 'application/json',
                'content-type': 'application/json'
            },
            type: "POST",
            url: "http://localhost:8080/api/users/createSupplier",
            data: JSON.stringify(createUser)
        }).done((data) => {
            console.log(data)
            let str = renderUser(data)
            $("#tbSupplier tbody").prepend(str);
            App.iziToast.showSuccessAlert("Thêm mới thành công")
            $("#modalCreateSupplier").modal('hide')
            enableTooltip();
        }).fail((jqHRX) => {
            console.log(jqHRX)
        });
    })

    $("#modalCreateSupplier").on("hidden.bs.modal", function () {

        $("#frmCreateSup")[0].reset();
        $('#modalCreateSupplier .modal-alert-danger').removeClass('show').addClass('hide');

    });

    $('.search').on('input', function (){
        let keyword = $('.search').val();
        searchByName(keyword);
    })

    $("#createSupplier").on("click", function (){
        $("#modalCreateSupplier").modal("show");
    })

    $(()=> {
        getAllProduct();
    })

</script>

</body>

</html>